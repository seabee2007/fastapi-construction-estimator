<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Digital Construction Estimator</title>
  <!-- Bootstrap CSS from CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Optional: Animate.css for animations -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <style>
    /* Base Styles */
    body {
      background: #f4f7f6;
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    /* Header */
    header {
      background: #343a40;
      color: #fff;
      padding: 20px 0;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    header h1 {
      margin: 0;
      font-size: 2.5rem;
      animation: fadeInDown 1s ease-out;
    }
    /* Container */
    .container {
      margin-top: 30px;
    }
    /* Form Styling */
    form {
      background: #ffffff;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    fieldset {
      border: none;
      margin-bottom: 20px;
      padding: 0;
    }
    legend {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 5px;
    }
    /* Form Controls */
    input,
    select,
    textarea {
      border-radius: 5px;
      border: 1px solid #ced4da;
      padding: 0.375rem 0.75rem;
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    input:focus,
    select:focus,
    textarea:focus {
      border-color: #86b7fe;
      box-shadow: 0 0 8px rgba(134,183,254,0.5);
    }
    /* Button Styles */
    .btn {
      transition: transform 0.2s ease-in-out;
    }
    .btn:hover {
      transform: scale(1.05);
    }
    /* Dynamic Input Groups */
    .input-group {
      margin-bottom: 10px;
    }
    .input-group .form-select,
    .input-group .form-control {
      border-radius: 0.25rem;
    }
    .input-group .btn-outline-danger {
      margin-left: 10px;
    }
    /* Modal Customization */
    .modal-content {
      border-radius: 10px;
    }
    .modal-header {
      background: #343a40;
      color: #fff;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
    .modal-title {
      font-size: 1.5rem;
    }
    .modal-footer {
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
    }
    /* Footer (optional) */
    footer {
      background: #343a40;
      color: #fff;
      text-align: center;
      padding: 10px 0;
      position: fixed;
      bottom: 0;
      width: 100%;
    }
    /* Animations */
    @keyframes fadeInDown {
      0% { opacity: 0; transform: translateY(-20px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    /* Scrollable Modal Bodies */
    #libraryModalBody, #equipmentModalBody {
      max-height: 400px;
      overflow-y: auto;
    }
    /* Hover effects for modal table rows */
    #libraryModalBody tr.library-row,
    #equipmentModalBody tr.equipment-row {
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    }
    #libraryModalBody tr.library-row:hover,
    #equipmentModalBody tr.equipment-row:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      background-color: #f0f0f0;
    }
    /* Widen first table column */
    #libraryModalBody td:first-child,
    #equipmentModalBody td:first-child {
      min-width: 150px;
    }
    /* Construction Activity Summary Styles */
    #casSummary {
      margin-top: 40px;
      padding: 20px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #casSummary h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    #casSummary .section-header {
      font-weight: bold;
      background: #e9ecef;
      padding: 5px 10px;
      border-radius: 5px;
      margin-top: 15px;
    }
    #casSummary table {
      width: 100%;
      margin-bottom: 10px;
    }
    #casSummary table, #casSummary th, #casSummary td {
      border: 1px solid #ccc;
      border-collapse: collapse;
      padding: 5px;
    }
  </style>
</head>
<body>
  <header class="py-4 bg-dark text-white text-center">
    <div class="container">
      <h1>Digital Construction Estimator</h1>
    </div>
  </header>
  
  <div class="container my-5">
    <!-- Main Form Section -->
    <form id="estimatorForm" class="p-4 bg-white rounded shadow">
      <!-- Updated Project Information -->
      <fieldset class="mb-4">
        <legend>Project Information</legend>
        <div class="mb-3 row">
          <div class="col-md-6">
            <label for="project_number" class="form-label">Project Number:</label>
            <input type="text" id="project_number" name="project_number" class="form-control" placeholder="PH5-800" required>
          </div>
          <div class="col-md-6">
            <label for="project_title" class="form-label">Project Title:</label>
            <input type="text" id="project_title" name="project_title" class="form-control" placeholder="CONSTRUCT SHED" required>
          </div>
        </div>
      </fieldset>
      
      <!-- Updated Activity Details -->
      <fieldset class="mb-4">
        <legend>Activity Details</legend>
        <div class="mb-3 row">
          <div class="col-md-6">
            <label for="activity_number" class="form-label">Activity Number:</label>
            <input type="text" id="activity_number" name="activity_number" class="form-control" placeholder="02200" required>
          </div>
          <div class="col-md-6">
            <label for="activity_title" class="form-label">Activity Title:</label>
            <input type="text" id="activity_title" name="activity_title" class="form-control" placeholder="EXCAVATE FOR FOOTERS" required>
          </div>
        </div>
        <div class="mb-3">
          <label for="description_of_work" class="form-label">Description of Work:</label>
          <textarea id="description_of_work" name="description_of_work" class="form-control" rows="3" required></textarea>
        </div>
        <div class="mb-3">
          <label for="method_of_construction" class="form-label">Method of Construction:</label>
          <textarea id="method_of_construction" name="method_of_construction" class="form-control" rows="3" required></textarea>
        </div>
      </fieldset>
      
      <!-- Labor Resources Section -->
      <fieldset class="mb-4">
        <legend>Labor Resources</legend>
        <div id="laborResourcesContainer"></div>
        <button type="button" class="btn btn-outline-success mb-3" onclick="addLaborResource()">Add Labor Resource</button>
      </fieldset>
      
      <!-- Work Elements Section -->
      <fieldset class="mb-4">
        <legend>Work Elements</legend>
        <div id="workElementsContainer"></div>
        <button type="button" class="btn btn-outline-primary mb-3" onclick="openLibraryModal()">Add Work Element</button>
      </fieldset>
      
      <!-- Equipment Section -->
      <fieldset class="mb-4">
        <legend>Equipment</legend>
        <div id="equipmentContainer"></div>
        <button type="button" class="btn btn-outline-warning mb-3" onclick="openEquipmentModal()">Add Equipment</button>
      </fieldset>
      
      <!-- Production Efficiency Factors (unchanged) -->
      <fieldset class="mb-4">
        <legend>Production Efficiency Factors</legend>
        <div id="efficiencyFactorsContainer" class="mb-3">
          <div class="row mb-2">
            <div class="col-md-3"><strong>Workload</strong></div>
            <div class="col-md-3"><select id="factor-workload" class="form-select"></select></div>
          </div>
          <div class="row mb-2">
            <div class="col-md-3"><strong>Site Area</strong></div>
            <div class="col-md-3"><select id="factor-site" class="form-select"></select></div>
          </div>
          <div class="row mb-2">
            <div class="col-md-3"><strong>Labor</strong></div>
            <div class="col-md-3"><select id="factor-labor" class="form-select"></select></div>
          </div>
          <div class="row mb-2">
            <div class="col-md-3"><strong>Supervision</strong></div>
            <div class="col-md-3"><select id="factor-supervision" class="form-select"></select></div>
          </div>
          <div class="row mb-2">
            <div class="col-md-3"><strong>Job Condition</strong></div>
            <div class="col-md-3"><select id="factor-job" class="form-select"></select></div>
          </div>
          <div class="row mb-2">
            <div class="col-md-3"><strong>Weather</strong></div>
            <div class="col-md-3"><select id="factor-weather" class="form-select"></select></div>
          </div>
          <div class="row mb-2">
            <div class="col-md-3"><strong>Equipment</strong></div>
            <div class="col-md-3"><select id="factor-equipment" class="form-select"></select></div>
          </div>
          <div class="row mb-2">
            <div class="col-md-3"><strong>Tactical/Logistical</strong></div>
            <div class="col-md-3"><select id="factor-tactical" class="form-select"></select></div>
          </div>
        </div>
        <div class="mb-3">
          <p><strong>Product Efficiency Factor:</strong> <span id="product-efficiency">67</span></p>
          <p><strong>Resulting Delay Factor:</strong> <span id="delay-factor">1.00</span></p>
        </div>
        <div class="row mb-2">
          <div class="col-md-3"><strong>Availability Factor</strong></div>
          <div class="col-md-3">
            <select id="availability-factor" class="form-select"></select>
          </div>
        </div>
        <div class="row mb-2">
          <div class="col-md-3"><strong>Manday Equivalent</strong></div>
          <div class="col-md-3">
            <select id="manday-equivalent" class="form-select">
              <option value="1.00">1.00</option>
              <option value="1.125" selected>1.125</option>
              <option value="1.25">1.25</option>
              <option value="1.375">1.375</option>
              <option value="1.50">1.50</option>
            </select>
          </div>
        </div>
      </fieldset>
      
      <div class="d-grid gap-2">
        <button type="submit" class="btn btn-lg btn-success">Get Final Estimate</button>
      </div>
    </form>

    <!-- Construction Activity Summary Section (PDF Format remains unchanged) -->
    <div id="casSummary">
      <h2>Construction Activity Summary Sheet</h2>
      
      <!-- Project & Activity Information -->
      <div class="section-header">Project & Activity Information</div>
      <p>
        <strong>Project Number:</strong> <span id="casProjectNumber">PH5-800</span>&nbsp;&nbsp;
        <strong>Project Title:</strong> <span id="casProjectTitle">CONSTRUCT SHED</span>
      </p>
      <p>
        <strong>Activity Number:</strong> <span id="casActivityNumber">02200</span>&nbsp;&nbsp;
        <strong>Activity Title:</strong> <span id="casActivityTitle">EXCAVATE FOR FOOTERS</span>
      </p>
          
      <!-- Work Details -->
      <div class="section-header">CA # 02200-1</div>
      <p><strong>DESCRIPTION OF WORK:</strong></p>
      <p id="casDescription">[Static Description]</p>
      <p><strong>METHOD OF CONSTRUCTION/ASSUMPTIONS:</strong></p>
      <p id="casMethod">[Static Method]</p>
      
      <!-- Labor Resources (Updated dynamically) -->
      <div class="section-header">LABOR RESOURCES</div>
      <table>
        <thead>
          <tr>
            <th>Skill Required</th>
            <th>Qty</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody id="casLaborTable">
          <!-- Labor rows will be dynamically inserted here -->
        </tbody>
      </table>
      <p><strong>Total Labor:</strong> <span id="casTotalLabor">0</span></p>
      <p><strong>Total Labor:</strong> <span id="casTotalLabor">2</span></p>
      <div class="section-header">PRODUCTION EFFICIENCY FACTOR</div>
      <p><strong>Product Efficiency Factor:</strong> <span id="casProductEfficiency">67</span></p>
      <p><strong>Resulting Delay Factor:</strong> <span id="casDelayFactor">1.00</span></p>
      <div class="section-header">CA # 02200-2</div>
      <p><strong>WORK ELEMENTS</strong></p>
      <table>
        <thead>
          <tr>
            <th>Code</th>
            <th>Description</th>
            <th>U/M</th>
            <th>Qty</th>
            <th>ManHrs Per Unit</th>
            <th>Work Multi</th>
            <th>Est. MDs</th>
          </tr>
        </thead>
        <tbody id="casWorkElements">
          <tr>
            <td>1302</td>
            <td>EXCAVATE USING, TRACTOR MTD. BACKHOE</td>
            <td>CD</td>
            <td>4</td>
            <td>0</td>
            <td>1.00</td>
            <td>0.05</td>
          </tr>
          <tr>
            <td>8</td>
            <td>HAND EXCAVATE TO DEPTH</td>
            <td>EA</td>
            <td>1</td>
            <td>6</td>
            <td>1.00</td>
            <td>0.79</td>
          </tr>
        </tbody>
      </table>
      <p><strong>TOOLS</strong></p>
      <table>
        <thead>
          <tr>
            <th>ID #</th>
            <th>Description</th>
            <th>Qty</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>6078</td>
            <td>SHOVEL SPOON TELEGRAPH EASTERN PATTERN 93N HANDLE</td>
            <td>1</td>
          </tr>
        </tbody>
      </table>
      <p><strong>EQUIPMENT</strong></p>
      <table>
        <thead>
          <tr>
            <th>ID #</th>
            <th>Description</th>
            <th>Qty</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>058700</td>
            <td>TRUCK DUMP 6X6 30000 GVW</td>
            <td>1</td>
          </tr>
          <tr>
            <td>434000</td>
            <td>EXCAVATOR WHEEL MOUNTED HYD OPERATED</td>
            <td>1</td>
          </tr>
          <tr>
            <td>453100</td>
            <td>LOADER SCOOP WHEEL MOUNTED 4X4</td>
            <td>1</td>
          </tr>
          <tr>
            <td>064300</td>
            <td>TRUCK STAKE 6X6 DED 46000 GVW</td>
            <td>1</td>
          </tr>
        </tbody>
      </table>
      <p><strong>MATERIALS</strong></p>
      <table>
        <thead>
          <tr>
            <th>BM LI</th>
            <th>Description</th>
            <th>Unit</th>
            <th>Qty</th>
            <th>LL</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>1</td>
            <td>CAUTION TAPE</td>
            <td>RL</td>
            <td>1</td>
            <td>No</td>
          </tr>
          <tr>
            <td>1</td>
            <td>PLASTIC SHEET</td>
            <td>RL</td>
            <td>1</td>
            <td>No</td>
          </tr>
        </tbody>
      </table>
      <div class="section-header">SAFETY PLAN</div>
      <p><strong>Safety Hazard:</strong> OPEN TRENCHES &nbsp;&nbsp; <strong>Control Measure:</strong> CLEARLY MARKED/BARRICADED</p>
      <p><strong>Safety Hazard:</strong> UNDERGROUND/UTILITIES &nbsp;&nbsp; <strong>Control Measure:</strong> MARKED TO ENSURE VISIBILITY</p>
      <div class="section-header">QUALITY CONTROL PLAN</div>
      <p><strong>Requirement:</strong> SIZE OF EXCAVATION &nbsp;&nbsp; <strong>Action:</strong> EXCAVATE TO DIMENSIONS SHOWN ON PRINTS ONLY</p>
      <p><strong>Requirement:</strong> OVER EXCAVATION &nbsp;&nbsp; <strong>Action:</strong> FILL OVER EXCAVATED AREAS WITH CONCRETE</p>
      <p><strong>Requirement:</strong> SPOIL STORAGE &nbsp;&nbsp; <strong>Action:</strong> STORE SPOIL MATERIAL TO PREVENT CONTAMINATION</p>
      <div class="section-header">ENVIRONMENTAL PLAN</div>
      <p><strong>Hazard:</strong> EQUIPMENT SPILL &nbsp;&nbsp; <strong>Action:</strong> MAINTAIN SPILL KIT AND SPILL PLAN ON SITE</p>
      <div class="section-header">CA # 02200-3: COMMENTS</div>
      <p id="casComments">DUE TO RAINY SEASONS PUMPS MAY BE REQUIRED. EXCAVATION TO BE COVERED EACH NIGHT AND MARKED WITH CAUTION TAPE.</p>
    </div>
  </div>
  
  <!-- Equipment Modal -->
  <div class="modal fade" id="equipmentModal" tabindex="-1" aria-labelledby="equipmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="equipmentModalLabel">Equipment Library</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="text" id="equipmentModalSearchInput" class="form-control" placeholder="Search equipment..." oninput="filterEquipmentModalTable()">
          </div>
          <div id="equipmentModalBody">
            <p>Loading equipment...</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Work Elements Modal -->
  <div class="modal fade" id="libraryModal" tabindex="-1" aria-labelledby="libraryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="libraryModalLabel">Work Elements Library</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <input type="text" id="modalSearchInput" class="form-control" placeholder="Search work elements..." oninput="filterModalTable()">
          </div>
          <div id="libraryModalBody">
            <p>Loading work elements...</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Final Estimate Modal -->
  <div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="resultModalLabel">Final Estimate</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="resultContent">
          <!-- Final estimate result will be injected here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Inline JavaScript -->
  <script>
    // Global active row variables for modals.
    let activeWorkElementRow = null;
    let activeEquipmentRow = null;
    
    // Function to update the CAS Summary (including labor resources) with user inputs.
    function updateCASSummary() {
      // Update project and activity fields.
      document.getElementById("casProjectNumber").textContent = document.getElementById("project_number").value;
      document.getElementById("casProjectTitle").textContent = document.getElementById("project_title").value;
      document.getElementById("casActivityNumber").textContent = document.getElementById("activity_number").value;
      document.getElementById("casActivityTitle").textContent = document.getElementById("activity_title").value;
      document.getElementById("casDescription").textContent = document.getElementById("description_of_work").value;
      document.getElementById("casMethod").textContent = document.getElementById("method_of_construction").value;
      
      // Update Labor Resources in the summary.
      const laborTable = document.getElementById("casLaborTable");
      laborTable.innerHTML = ""; // Clear existing rows.
      let totalLabor = 0;
      const laborRows = document.querySelectorAll("#laborResourcesContainer .input-group");
      laborRows.forEach(row => {
        const skill = row.querySelector("select[name='labor_skill']").value;
        const quantity = parseFloat(row.querySelector("input[name='labor_quantity']").value) || 0;
        totalLabor += quantity;
        const tr = document.createElement("tr");
        const tdSkill = document.createElement("td");
        tdSkill.textContent = skill;
        const tdQuantity = document.createElement("td");
        tdQuantity.textContent = quantity;
        const tdRemarks = document.createElement("td");
        tdRemarks.textContent = ""; // Optionally include remarks if available.
        tr.appendChild(tdSkill);
        tr.appendChild(tdQuantity);
        tr.appendChild(tdRemarks);
        laborTable.appendChild(tr);
      });
      document.getElementById("casTotalLabor").textContent = totalLabor;
    }
    
    // Production Efficiency Factors dropdowns.
    function populateFactorDropdowns() {
      const factorIds = [
        "factor-workload", "factor-site", "factor-labor", "factor-supervision",
        "factor-job", "factor-weather", "factor-equipment", "factor-tactical"
      ];
      factorIds.forEach(id => {
        const select = document.getElementById(id);
        select.innerHTML = "";
        for (let i = 0; i <= 100; i++) {
          const opt = document.createElement("option");
          opt.value = i;
          opt.textContent = i;
          if (i === 67) opt.selected = true;
          select.appendChild(opt);
        }
        select.addEventListener("change", recalcEfficiency);
      });
    }
    
    function populateAvailabilityDropdown() {
      const availSelect = document.getElementById("availability-factor");
      availSelect.innerHTML = "";
      for (let i = 0; i <= 100; i += 5) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = i + "%";
        if (i === 75) opt.selected = true;
        availSelect.appendChild(opt);
      }
    }
    
    function recalcEfficiency() {
      const factorIds = [
        "factor-workload", "factor-site", "factor-labor", "factor-supervision",
        "factor-job", "factor-weather", "factor-equipment", "factor-tactical"
      ];
      let sum = 0;
      factorIds.forEach(id => {
        sum += parseInt(document.getElementById(id).value, 10);
      });
      const avg = sum / factorIds.length;
      document.getElementById("product-efficiency").textContent = avg.toFixed(1);
      const delay = (avg !== 0) ? (67 / avg) : 0;
      document.getElementById("delay-factor").textContent = delay.toFixed(2);
    }
    
    window.addEventListener("load", () => {
      populateFactorDropdowns();
      populateAvailabilityDropdown();
      recalcEfficiency();
    });
    
    // Labor Resources Functions
    function addLaborResource() {
      const container = document.getElementById("laborResourcesContainer");
      const row = document.createElement("div");
      row.className = "input-group mb-2";
      row.innerHTML = `
        <select name="labor_skill" class="form-select">
          <option value="Builder">Builder</option>
          <option value="Steel Worker">Steel Worker</option>
          <option value="Utilitiesman">Utilitiesman</option>
          <option value="Engineering Aid">Engineering Aid</option>
          <option value="Construction Electrician">Construction Electrician</option>
          <option value="Equipment Operator">Equipment Operator</option>
          <option value="Construction Mechanic">Construction Mechanic</option>
        </select>
        <input type="number" name="labor_quantity" class="form-control" placeholder="Quantity" step="1" min="0" required>
        <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">Remove</button>
      `;
      container.appendChild(row);
    }
    window.addLaborResource = addLaborResource;
    
    // Work Elements Modal Functions (unchanged from previous integration)
    function addWorkElementPlaceholder() {
      const container = document.getElementById("workElementsContainer");
      const row = document.createElement("div");
      row.className = "input-group mb-2";
      row.innerHTML = `
        <input type="text" name="work_element_search" class="form-control" placeholder="Work element code" readonly>
        <span class="input-group-text">U/M: <span class="um-field"></span></span>
        <span class="input-group-text">Multiplier: <span class="multiplier-field"></span></span>
        <input type="number" name="work_element_quantity" class="form-control" placeholder="Quantity" step="0.1" min="0" required>
        <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">Remove</button>
      `;
      container.appendChild(row);
      activeWorkElementRow = row;
    }
    
    function openLibraryModal() {
      addWorkElementPlaceholder();
      document.getElementById("modalSearchInput").value = "";
      filterModalTable();
      fetchWorkElementsForModal();
      const modal = new bootstrap.Modal(document.getElementById("libraryModal"));
      modal.show();
    }
    window.openLibraryModal = openLibraryModal;
    
    async function fetchWorkElementsForModal() {
      try {
        const res = await fetch("/work-elements");
        const results = await res.json();
        populateModalTable(results);
      } catch (error) {
        console.error("Error fetching work elements:", error);
      }
    }
    
    function populateModalTable(data) {
      const modalBody = document.getElementById("libraryModalBody");
      modalBody.innerHTML = "";
      const table = document.createElement("table");
      table.className = "table table-striped";
      table.id = "modalTable";
      
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      ["Code", "Description", "Man Hours/Unit", "U/M", "Multiplier"].forEach(text => {
        const th = document.createElement("th");
        th.textContent = text;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      const tbody = document.createElement("tbody");
      data.forEach(item => {
        const row = document.createElement("tr");
        row.className = "library-row";
        row.style.cursor = "pointer";
        
        const cellCode = document.createElement("td");
        cellCode.textContent = item.code;
        row.appendChild(cellCode);
        
        const cellDesc = document.createElement("td");
        cellDesc.textContent = item.description;
        row.appendChild(cellDesc);
        
        const cellMHPU = document.createElement("td");
        cellMHPU.textContent = (item.man_hours_per_unit !== undefined ? item.man_hours_per_unit : "N/A");
        row.appendChild(cellMHPU);
        
        const cellUM = document.createElement("td");
        cellUM.textContent = (item.uom ? item.uom : "N/A");
        row.appendChild(cellUM);
        
        const cellMultiplier = document.createElement("td");
        cellMultiplier.textContent = (item.multiplier ? item.multiplier : "N/A");
        row.appendChild(cellMultiplier);
        
        row.addEventListener("click", () => {
          selectWorkElement(item.code, item.description, item.uom || "N/A", item.multiplier || "N/A");
        });
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      modalBody.appendChild(table);
    }
    
    function filterModalTable() {
      const searchValue = document.getElementById("modalSearchInput").value.toLowerCase();
      const table = document.getElementById("modalTable");
      if (!table) return;
      const rows = table.getElementsByTagName("tr");
      for (let i = 1; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        let rowText = "";
        for (let j = 0; j < cells.length; j++) {
          rowText += cells[j].textContent.toLowerCase() + " ";
        }
        rows[i].style.display = rowText.indexOf(searchValue) > -1 ? "" : "none";
      }
    }
    
    function selectWorkElement(code, description, uom, multiplier) {
      if (activeWorkElementRow) {
        activeWorkElementRow.innerHTML = `
          <input type="text" name="work_element_search" class="form-control" value="${code} - ${description}" readonly>
          <span class="input-group-text">U/M: <span class="um-field">${uom}</span></span>
          <span class="input-group-text">Multiplier: <span class="multiplier-field">${multiplier}</span></span>
          <input type="number" name="work_element_quantity" class="form-control" placeholder="Quantity" step="0.1" min="0" required>
          <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">Remove</button>
        `;
        activeWorkElementRow = null;
      } else {
        const container = document.getElementById("workElementsContainer");
        const row = document.createElement("div");
        row.className = "input-group mb-2";
        row.innerHTML = `
          <input type="text" name="work_element_search" class="form-control" value="${code} - ${description}" readonly>
          <span class="input-group-text">U/M: <span class="um-field">${uom}</span></span>
          <span class="input-group-text">Multiplier: <span class="multiplier-field">${multiplier}</span></span>
          <input type="number" name="work_element_quantity" class="form-control" placeholder="Quantity" step="0.1" min="0" required>
          <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">Remove</button>
        `;
        container.appendChild(row);
      }
      const modalEl = document.getElementById("libraryModal");
      const modal = bootstrap.Modal.getInstance(modalEl);
      if (modal) modal.hide();
    }
    window.selectWorkElement = selectWorkElement;
    
    // Equipment Modal Functions
    function openEquipmentModal() {
      addEquipmentPlaceholder();
      document.getElementById("equipmentModalSearchInput").value = "";
      filterEquipmentModalTable();
      fetchEquipmentForModal();
      const modal = new bootstrap.Modal(document.getElementById("equipmentModal"));
      modal.show();
    }
    window.openEquipmentModal = openEquipmentModal;
    
    function addEquipmentPlaceholder() {
      const container = document.getElementById("equipmentContainer");
      const row = document.createElement("div");
      row.className = "input-group mb-2";
      row.innerHTML = `
        <input type="text" name="equipment_search" class="form-control" placeholder="Equipment name" readonly>
        <input type="number" name="equipment_quantity" class="form-control" placeholder="Quantity" step="1" min="0" required>
        <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">Remove</button>
      `;
      container.appendChild(row);
      activeEquipmentRow = row;
    }
    
    async function fetchEquipmentForModal() {
      try {
        const res = await fetch("/equipment");
        const results = await res.json();
        populateEquipmentModalTable(results);
      } catch (error) {
        console.error("Error fetching equipment:", error);
      }
    }
    
    function populateEquipmentModalTable(data) {
      const modalBody = document.getElementById("equipmentModalBody");
      modalBody.innerHTML = "";
      const table = document.createElement("table");
      table.className = "table table-striped";
      table.id = "equipmentModalTable";
      
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");
      ["ID #", "Description", "Qty Available"].forEach(text => {
        const th = document.createElement("th");
        th.textContent = text;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      const tbody = document.createElement("tbody");
      data.forEach(item => {
        const row = document.createElement("tr");
        row.className = "equipment-row";
        row.style.cursor = "pointer";
        
        const cellID = document.createElement("td");
        cellID.textContent = item.id;
        row.appendChild(cellID);
        
        const cellDesc = document.createElement("td");
        cellDesc.textContent = item.description;
        row.appendChild(cellDesc);
        
        const cellQty = document.createElement("td");
        cellQty.textContent = (item.quantity ? item.quantity : "N/A");
        row.appendChild(cellQty);
        
        row.addEventListener("click", () => {
          selectEquipment(item.id, item.description);
        });
        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      modalBody.appendChild(table);
    }
    
    function filterEquipmentModalTable() {
      const searchValue = document.getElementById("equipmentModalSearchInput").value.toLowerCase();
      const table = document.getElementById("equipmentModalTable");
      if (!table) return;
      const rows = table.getElementsByTagName("tr");
      for (let i = 1; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        let rowText = "";
        for (let j = 0; j < cells.length; j++) {
          rowText += cells[j].textContent.toLowerCase() + " ";
        }
        rows[i].style.display = rowText.indexOf(searchValue) > -1 ? "" : "none";
      }
    }
    
    function selectEquipment(id, description) {
      if (activeEquipmentRow) {
        activeEquipmentRow.innerHTML = `
          <input type="text" name="equipment_search" class="form-control" value="${id} - ${description}" readonly>
          <input type="number" name="equipment_quantity" class="form-control" placeholder="Quantity" step="1" min="0" required>
          <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">Remove</button>
        `;
        activeEquipmentRow = null;
      } else {
        const container = document.getElementById("equipmentContainer");
        const row = document.createElement("div");
        row.className = "input-group mb-2";
        row.innerHTML = `
          <input type="text" name="equipment_search" class="form-control" value="${id} - ${description}" readonly>
          <input type="number" name="equipment_quantity" class="form-control" placeholder="Quantity" step="1" min="0" required>
          <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">Remove</button>
        `;
        container.appendChild(row);
      }
      const modalEl = document.getElementById("equipmentModal");
      const modal = bootstrap.Modal.getInstance(modalEl);
      if (modal) modal.hide();
    }
    window.selectEquipment = selectEquipment;
    
    // Form Submission Handler – update CAS Summary (including Labor Resources) before processing.
    document.getElementById("estimatorForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      // Update the Construction Activity Summary with current user inputs.
      updateCASSummary();
      
      // Build the payload.
      const form = e.target;
      const data = {
        project_number: form.project_number.value,
        project_title: form.project_title.value,
        activity_number: form.activity_number.value,
        activity_title: form.activity_title.value,
        description_of_work: form.description_of_work.value,
        method_of_construction: form.method_of_construction.value,
        labor_resources: [],
        work_elements: [],
        equipment: []
      };
      
      // Gather Labor Resources.
      const laborRows = document.querySelectorAll("#laborResourcesContainer .input-group");
      laborRows.forEach(row => {
        const skill = row.querySelector("select[name='labor_skill']").value;
        const quantity = parseInt(row.querySelector("input[name='labor_quantity']").value, 10);
        data.labor_resources.push({ skill, quantity });
      });
      
      // Gather Work Elements.
      const workRows = document.querySelectorAll("#workElementsContainer .input-group");
      workRows.forEach(row => {
        const codeAndDescription = row.querySelector("input[name='work_element_search']").value;
        const quantity = parseFloat(row.querySelector("input[name='work_element_quantity']").value);
        data.work_elements.push({ code: codeAndDescription, description: codeAndDescription, quantity });
      });
      
      // Gather Equipment.
      const equipRows = document.querySelectorAll("#equipmentContainer .input-group");
      equipRows.forEach(row => {
        const name = row.querySelector("input[name='equipment_search']").value;
        const quantity = parseFloat(row.querySelector("input[name='equipment_quantity']").value);
        data.equipment.push({ name, quantity });
      });
      
      console.log("Payload:", data);
      
      try {
        const res = await fetch("/final-estimate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        console.log("Final Estimate:", result);
        document.getElementById("resultContent").innerText = JSON.stringify(result, null, 2);
        const modal = new bootstrap.Modal(document.getElementById("resultModal"));
        modal.show();
      } catch (error) {
        console.error("Error getting final estimate:", error);
        document.getElementById("resultContent").innerText = "Error getting final estimate.";
        const modal = new bootstrap.Modal(document.getElementById("resultModal"));
        modal.show();
      }
    });
  </script>
  <!-- Bootstrap Bundle with Popper from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
